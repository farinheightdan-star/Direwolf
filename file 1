import os
import json
from telegram import Update
from telegram.ext import (
    ApplicationBuilder,
    MessageHandler,
    CommandHandler,
    filters,
    ContextTypes,
)
from openai import OpenAI

client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

BOT_USERNAME = "@web3wolfbot"
MEMORY_FILE = "memory.json"

# Load memory
def load_memory():
    try:
        with open(MEMORY_FILE, "r") as f:
            return json.load(f)
    except:
        return {}

def save_memory(memory):
    with open(MEMORY_FILE, "w") as f:
        json.dump(memory, f)

memory = load_memory()

SYSTEM_PROMPT = """
You are Direwolf (Wolf), a Web3 strategic sales operator.

Mission:
Close deals with launchpads, incubators, exchanges, and Web3 projects.

Rules:
- Precision over fluff.
- Identify leverage.
- Convert features to strategic advantage.
- Be persuasive and data-driven.
- Stay concise.

Response Structure:
1. Situation Analysis
2. Leverage
3. Strategic Angle
4. Suggested Outreach
"""

async def ai_response(user_id, user_message):

    user_memory = memory.get(str(user_id), {})
    product_context = user_memory.get("product", "No product set.")

    messages = [
        {"role": "system", "content": SYSTEM_PROMPT},
        {"role": "system", "content": f"User Product Context: {product_context}"},
        {"role": "user", "content": user_message},
    ]

    response = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=messages,
    )

    return response.choices[0].message.content


# COMMANDS

async def set_product(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    product_info = " ".join(context.args)

    if not product_info:
        await update.message.reply_text("Usage: /setproduct Describe your product.")
        return

    memory[str(user_id)] = {"product": product_info}
    save_memory(memory)

    await update.message.reply_text("Product context saved.")


async def analyze(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    text = " ".join(context.args)

    if not text:
        await update.message.reply_text("Usage: /analyze Describe the situation.")
        return

    reply = await ai_response(user_id, f"Analyze this: {text}")
    await update.message.reply_text(reply)


async def pitch(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    target = " ".join(context.args)

    if not target:
        await update.message.reply_text("Usage: /pitch Target description.")
        return

    reply = await ai_response(user_id, f"Craft a cold outreach pitch for: {target}")
    await update.message.reply_text(reply)


async def objection(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    objection_text = " ".join(context.args)

    if not objection_text:
        await update.message.reply_text("Usage: /objection Paste founder objection.")
        return

    reply = await ai_response(user_id, f"Handle this objection: {objection_text}")
    await update.message.reply_text(reply)


async def reset(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    memory.pop(str(user_id), None)
    save_memory(memory)
    await update.message.reply_text("Memory reset.")


# NORMAL CHAT HANDLER
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not update.message:
        return

    text = update.message.text

    if update.message.chat.type != "private":
        if BOT_USERNAME not in text:
            return
        text = text.replace(BOT_USERNAME, "").strip()

    user_id = update.effective_user.id
    reply = await ai_response(user_id, text)
    await update.message.reply_text(reply)


app = ApplicationBuilder().token(os.getenv("BOT_TOKEN")).build()

app.add_handler(CommandHandler("setproduct", set_product))
app.add_handler(CommandHandler("analyze", analyze))
app.add_handler(CommandHandler("pitch", pitch))
app.add_handler(CommandHandler("objection", objection))
app.add_handler(CommandHandler("reset", reset))

app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))

app.run_polling()
